
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2016-02-11
 Rendered using Reflow Maven Skin 1.1.1 (http://andriusvelykis.github.io/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>Configuration | Apache Beam</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />
 
		<link href="http://netdna.bootstrapcdn.com/bootswatch/2.3.2/united/bootstrap.min.css" rel="stylesheet" />
		<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href=".//css/bootswatch.css" rel="stylesheet" />
		<link href=".//css/reflow-skin.css" rel="stylesheet" />

		<link href="http://yandex.st/highlightjs/7.5/styles/github.min.css" rel="stylesheet" />

		<link href=".//css/lightbox.css" rel="stylesheet" />

		<link href=".//css/site.css" rel="stylesheet" />
		<link href=".//css/print.css" rel="stylesheet" media="print" />

		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->



	</head>

	<body class="page-configuration project-site" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target="#top-nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="./"><img src="http://beam.incubator.apache.org/images/beam-123x43.png" /></a>
					<div class="nav-collapse collapse" id="top-nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="./" title="Home">Home</a></li>
									<li ><a href="getting-started.html" title="Getting started">Getting started</a></li>
									<li ><a href="guides.html" title="Guides">Guides</a></li>
									<li ><a href="concepts.html" title="Concepts">Concepts</a></li>
									<li ><a href="samples.html" title="Samples">Samples</a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Privacy <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="privacy-policy.html" title="Site policy">Site policy</a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Contribute <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="mail-lists.html" title="Mailing lists">Mailing lists</a></li>
									<li ><a href="source-repository.html" title="Source">Source</a></li>
									<li ><a href="issue-tracking.html" title="Issues">Issues</a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Community <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="mail-lists.html" title="Mailing lists">Mailing lists</a></li>
									<li ><a href="team-list.html" title="Team">Team</a></li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>

	<div class="container">

	<!-- Masthead
	================================================== -->

	<header>
		<div>
			<ul class="breadcrumb">
				<li class="projectVersion version-date">Version: 1.0.0-incubating-SNAPSHOT</li>
				<li class="divider">|</li>
				<li class="publishDate version-date">Last Published: 2016-02-11</li>
			</ul>
		</div>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span8">
			<div class="body-content">
<!-- ~ Licensed to the Apache Software Foundation (ASF) under one or more
  ~ contributor license agreements.  See the NOTICE file distributed with
  ~ this work for additional information regarding copyright ownership.
  ~ The ASF licenses this file to You under the Apache License, Version 2.0
  ~ (the "License"); you may not use this file except in compliance with
  ~ the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License. --> 
<div class="page-header">
 <h1 id="configuration">Configuration</h1>
</div> 
<div class="section"> 
 <h2 id="Changing_the_default_configuration">Changing the default configuration</h2> 
 <p>If you want to change the default configuration, you can perform any modification you want in the $MY_KARAF_HOME/etc directory.</p> 
 <p>The context server configuration is kept in the $MY_KARAF_HOME/etc/org.apache.unomi.web.cfg . It defines the addresses and port where it can be found :</p> 
 <div class="source"> 
  <pre>contextserver.address=localhost
contextserver.port=8181
contextserver.secureAddress=localhost
contextserver.securePort=9443
contextserver.domain=apache.org
</pre> 
 </div> 
 <p>If you need to specify an Elasticsearch cluster name that is different than the default, it is recommended to do this BEFORE you start the server for the first time, or you will loose all the data you have stored previously.</p> 
 <p>To change the cluster name, first create a file called </p> 
 <div class="source"> 
  <pre>$MY_KARAF_HOME/etc/org.apache.unomi.persistence.elasticsearch.cfg
</pre> 
 </div> 
 <p>with the following contents:</p> 
 <div class="source"> 
  <pre>cluster.name=contextElasticSearch
index.name=context
elasticSearchConfig=file:${karaf.etc}/elasticsearch.yml
</pre> 
 </div> 
 <p>And replace the cluster.name parameter here by your cluster name.</p> 
 <p>You can also put an elasticsearch configuration file in $MY_KARAF_HOME/etc/elasticsearch.yml , and put any standard Elasticsearch configuration options in this last file.</p> 
 <p>If you want your context server to be a client only on a cluster of elasticsearch nodes, just set the node.data property to false.</p> 
</div> 
<div class="section"> 
 <h2 id="Installing_the_MaxMind_GeoIPLite2_IP_lookup_database">Installing the MaxMind GeoIPLite2 IP lookup database</h2> 
 <p>The Context Server requires an IP database in order to resolve IP addresses to user location. The GeoLite2 database can be downloaded from MaxMind here : <a class="externalLink" href="http://dev.maxmind.com/geoip/geoip2/geolite2/">http://dev.maxmind.com/geoip/geoip2/geolite2/</a></p> 
 <p>Simply download the GeoLite2-City.mmdb file into the “etc” directory.</p> 
</div> 
<div class="section"> 
 <h2 id="Installing_Geonames_database">Installing Geonames database</h2> 
 <p>Context server includes a geocoding service based on the geonames database ( <a class="externalLink" href="http://www.geonames.org/">http://www.geonames.org/</a> ). It can be used to create conditions on countries or cities.</p> 
 <p>In order to use it, you need to install the Geonames database into . Get the “allCountries.zip” database from here : <a class="externalLink" href="http://download.geonames.org/export/dump/">http://download.geonames.org/export/dump/</a></p> 
 <p>Download it and put it in the “etc” directory, without unzipping it. Edit $MY_KARAF_HOME/etc/org.apache.unomi.geonames.cfg and set request.geonamesDatabase.forceImport to true, import should start right away. Otherwise, import should start at the next startup. Import runs in background, but can take about 15 minutes. At the end, you should have about 4 million entries in the geonames index.</p> 
</div> 
<div class="section"> 
 <h2 id="REST_API_Security">REST API Security</h2> 
 <p>The Context Server REST API is protected using JAAS authentication and using Basic or Digest HTTP auth. By default, the login/password for the REST API full administrative access is “karaf/karaf”.</p> 
 <p>The generated package is also configured with a default SSL certificate. You can change it by following these steps :</p> 
 <ol style="list-style-type: decimal"> 
  <li> <p>Replace the existing keystore in $MY_KARAF_HOME/etc/keystore by your own certificate :</p> <p><a class="externalLink" href="http://wiki.eclipse.org/Jetty/Howto/Configure_SSL">http://wiki.eclipse.org/Jetty/Howto/Configure_SSL</a></p></li> 
  <li> <p>Update the keystore and certificate password in $MY_KARAF_HOME/etc/custom.properties file :</p></li> 
 </ol> 
 <div class="source"> 
  <pre>    org.osgi.service.http.secure.enabled = true
    org.ops4j.pax.web.ssl.keystore=${karaf.etc}/keystore
    org.ops4j.pax.web.ssl.password=changeme
    org.ops4j.pax.web.ssl.keypassword=changeme
    org.osgi.service.http.port.secure=9443
</pre> 
 </div> 
 <p>You should now have SSL setup on Karaf with your certificate, and you can test it by trying to access it on port 9443.</p> 
</div> 
<div class="section"> 
 <h2 id="Automatic_profile_merging">Automatic profile merging</h2> 
 <p>The context server is capable of merging profiles based on a common property value. In order to use this, you must add the MergeProfileOnPropertyAction to a rule (such as a login rule for example), and configure it with the name of the property that will be used to identify the profiles to be merged. An example could be the “email” property, meaning that if two (or more) profiles are found to have the same value for the “email” property they will be merged by this action.</p> 
 <p>Upon merge, the old profiles are marked with a “mergedWith” property that will be used on next profile access to delete the original profile and replace it with the merged profile (aka “master” profile). Once this is done, all cookie tracking will use the merged profile.</p> 
 <p>To test, simply configure the action in the “login” or “facebookLogin” rules and set it up on the “email” property. Upon sending one of the events, all matching profiles will be merged.</p> 
</div> 
<div class="section"> 
 <h2 id="Securing_a_production_environment">Securing a production environment</h2> 
 <p>Before going live with a project, you should <i>absolutely</i> read the following section that will help you setup a proper secure environment for running your context server. </p> 
 <p>Step 1: Install and configure a firewall </p> 
 <p>You should setup a firewall around your cluster of context servers and/or Elasticsearch nodes. If you have an application-level firewall you should only allow the following connections open to the whole world : </p> 
 <ul> 
  <li><a class="externalLink" href="http://localhost:8181/context.js">http://localhost:8181/context.js</a></li> 
  <li><a class="externalLink" href="http://localhost:8181/eventcollector">http://localhost:8181/eventcollector</a></li> 
 </ul> 
 <p>All other ports should not be accessible to the world.</p> 
 <p>For your Context Server client applications (such as the Jahia CMS), you will need to make the following ports accessible : </p> 
 <div class="source"> 
  <pre>8181 (Context Server HTTP port) 
9443 (Context Server HTTPS port)
</pre> 
 </div> 
 <p>The context server actually requires HTTP Basic Auth for access to the Context Server administration REST API, so it is highly recommended that you design your client applications to use the HTTPS port for accessing the REST API.</p> 
 <p>The user accounts to access the REST API are actually routed through Karaf’s JAAS support, which you may find the documentation for here : </p> 
 <ul> 
  <li><a class="externalLink" href="http://karaf.apache.org/manual/latest/users-guide/security.html">http://karaf.apache.org/manual/latest/users-guide/security.html</a></li> 
 </ul> 
 <p>The default username/password is </p> 
 <div class="source"> 
  <pre>karaf/karaf
</pre> 
 </div> 
 <p>You should really change this default username/password as soon as possible. To do so, simply modify the following file : </p> 
 <div class="source"> 
  <pre>$MY_KARAF_HOME/etc/users.properties
</pre> 
 </div> 
 <p>For your context servers, and for any standalone Elasticsearch nodes you will need to open the following ports for proper node-to-node communication : 9200 (Elasticsearch REST API), 9300 (Elasticsearch TCP transport)</p> 
 <p>Of course any ports listed here are the default ports configured in each server, you may adjust them if needed.</p> 
 <p>Step 2 : Adjust the Context Server IP filtering</p> 
 <p>By default the Context Server limits to connections to port 9200 and 9300 to the following IP ranges</p> 
 <div class="source"> 
  <pre>- localhost
- 127.0.0.1
- ::1
- the current subnet (i.e., 192.168.1.0-192.168.1.255)
</pre> 
 </div> 
 <p>(this is done using a custom plugin for Elasticsearch, that you may find here : <a class="externalLink" href="https://git-wip-us.apache.org/repos/asf/incubator-unomi/context-server/persistence-elasticsearch/plugins/security">https://git-wip-us.apache.org/repos/asf/incubator-unomi/context-server/persistence-elasticsearch/plugins/security</a>)</p> 
 <p>You can adjust this setting by using the following setting in the $MY_KARAF_HOME/etc/elasticsearch.yml file : </p> 
 <div class="source"> 
  <pre>security.ipranges: localhost,127.0.0.1,::1,10.0.1.0-10.0.1.255
</pre> 
 </div> 
 <p>Step 3 : Follow industry recommended best practices for securing Elasticsearch</p> 
 <p>You may find more valuable recommendations here : </p> 
 <ul> 
  <li><a class="externalLink" href="https://www.elastic.co/blog/found-elasticsearch-security">https://www.elastic.co/blog/found-elasticsearch-security</a></li> 
  <li><a class="externalLink" href="https://www.elastic.co/blog/scripting-security">https://www.elastic.co/blog/scripting-security</a></li> 
 </ul> 
 <p>Step 4 : Setup a proxy in front of the context server</p> 
 <p>As an alternative to an application-level firewall, you could also route all traffic to the context server through a proxy, and use it to filter any communication.</p> 
</div> 
<div class="section"> 
 <h2 id="Integrating_with_an_Apache_HTTP_web_server">Integrating with an Apache HTTP web server</h2> 
 <p>If you want to setup an Apache HTTP web server in from of Apache Unomi, here is an example configuration using mod_proxy.</p> 
 <p>In your Unomi package directory, in /etc/org.apache.unomi.web.cfg for unomi.apache.org</p> 
 <p>contextserver.address=unomi.apache.org contextserver.port=80 contextserver.secureAddress=unomi.apache.org contextserver.securePort=443 contextserver.domain=apache.org</p> 
 <p>Main virtual host config:</p> 
 <div class="source"> 
  <pre>&lt;VirtualHost *:80&gt;
        Include /var/www/vhosts/unomi.apache.org/conf/common.conf
&lt;/VirtualHost&gt;

&lt;IfModule mod_ssl.c&gt;
    &lt;VirtualHost *:443&gt;
        Include /var/www/vhosts/unomi.apache.org/conf/common.conf

        SSLEngine on

        SSLCertificateFile    /var/www/vhosts/unomi.apache.org/conf/ssl/24d5b9691e96eafa.crt
        SSLCertificateKeyFile /var/www/vhosts/unomi.apache.org/conf/ssl/apache.org.key
        SSLCertificateChainFile /var/www/vhosts/unomi.apache.org/conf/ssl/gd_bundle-g2-g1.crt


        &lt;FilesMatch &quot;\.(cgi|shtml|phtml|php)$&quot;&gt;
                SSLOptions +StdEnvVars
        &lt;/FilesMatch&gt;
        &lt;Directory /usr/lib/cgi-bin&gt;
                SSLOptions +StdEnvVars
        &lt;/Directory&gt;
        BrowserMatch &quot;MSIE [2-6]&quot; \
                nokeepalive ssl-unclean-shutdown \
                downgrade-1.0 force-response-1.0
        BrowserMatch &quot;MSIE [17-9]&quot; ssl-unclean-shutdown

    &lt;/VirtualHost&gt;
&lt;/IfModule&gt;
</pre> 
 </div> 
 <p>common.conf:</p> 
 <div class="source"> 
  <pre>ServerName unomi.apache.org
ServerAdmin webmaster@apache.org

DocumentRoot /var/www/vhosts/unomi.apache.org/html
CustomLog /var/log/apache2/access-unomi.apache.org.log combined
&lt;Directory /&gt;
        Options FollowSymLinks
        AllowOverride None
&lt;/Directory&gt;
&lt;Directory /var/www/vhosts/unomi.apache.org/html&gt;
        Options FollowSymLinks MultiViews
        AllowOverride None
        Order allow,deny
        allow from all
&lt;/Directory&gt;
&lt;Location /cxs&gt;
    Order deny,allow
    deny from all
    allow from 88.198.26.2
    allow from www.apache.org
&lt;/Location&gt;

RewriteEngine On
RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
RewriteRule .* - [F]
ProxyPreserveHost On
ProxyPass /server-status !
ProxyPass /robots.txt !

RewriteCond %{HTTP_USER_AGENT} Googlebot [OR]
RewriteCond %{HTTP_USER_AGENT} msnbot [OR]
RewriteCond %{HTTP_USER_AGENT} Slurp
RewriteRule ^.* - [F,L]

ProxyPass / http://localhost:8181/ connectiontimeout=20 timeout=300 ttl=120
ProxyPassReverse / http://localhost:8181/
</pre> 
 </div> 
</div>
			</div>
		</div>
		<div class="span4">
			<div id="toc-sidebar">
				<div class="well">
					<ul class="nav nav-list">
						<li class="nav-header">Table of Contents</li>
		<li class="dropdown"><a href="#configuration" title="Configuration">Configuration <b class="caret"></b></a>
			<ul class="nav nav-list">
		<li><a href="#Changing_the_default_configuration" title="Changing the default configuration">Changing the default configuration</a>
		<li><a href="#Installing_the_MaxMind_GeoIPLite2_IP_lookup_database" title="Installing the MaxMind GeoIPLite2 IP lookup database">Installing the MaxMind GeoIPLite2 IP lookup database</a>
		<li><a href="#Installing_Geonames_database" title="Installing Geonames database">Installing Geonames database</a>
		<li><a href="#REST_API_Security" title="REST API Security">REST API Security</a>
		<li><a href="#Automatic_profile_merging" title="Automatic profile merging">Automatic profile merging</a>
		<li><a href="#Securing_a_production_environment" title="Securing a production environment">Securing a production environment</a>
		<li><a href="#Integrating_with_an_Apache_HTTP_web_server" title="Integrating with an Apache HTTP web server">Integrating with an Apache HTTP web server</a>
				<li class="divider"></li>
			</ul>
		</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->

	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Documentation</li>
						<li >
							<a href="./" title="Home">Home</a>
						</li>
						<li >
							<a href="getting-started.html" title="Getting started">Getting started</a>
						</li>
						<li >
							<a href="guides.html" title="Guides">Guides</a>
						</li>
						<li >
							<a href="concepts.html" title="Concepts">Concepts</a>
						</li>
						<li >
							<a href="samples.html" title="Samples">Samples</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Contribute</li>
						<li >
							<a href="mail-lists.html" title="Mailing lists">Mailing lists</a>
						</li>
						<li >
							<a href="source-repository.html" title="Source">Source</a>
						</li>
						<li >
							<a href="issue-tracking.html" title="Issues">Issues</a>
						</li>
						<li class="nav-header">Community</li>
						<li >
							<a href="mail-lists.html" title="Mailing lists">Mailing lists</a>
						</li>
						<li >
							<a href="team-list.html" title="Team">Team</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Privacy</li>
						<li >
							<a href="privacy-policy.html" title="Site policy">Site policy</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-description">
					<blockquote>© 2016 Apache Software Foundation</blockquote>
				</div>
			</div>
		</div>
	</footer>

	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2016 <a href="http://www.apache.org">Apache Software Foundation</a>. All Rights Reserved.</p>
				<p><a href="http://github.com/andriusvelykis/reflow-maven-skin" title="Reflow Maven skin">Reflow Maven skin</a> by <a href="http://andrius.velykis.lt" target="_blank" title="Andrius Velykis">Andrius Velykis</a>.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
	<script src=".//js/lightbox.min.js"></script>
	<script src=".//js/reflow-scroll.js"></script>
	<script src="http://yandex.st/highlightjs/7.5/highlight.min.js"></script>

	<script src=".//js/reflow-skin.js"></script>

	</body>
</html>
